sudo: required
matrix:
- language: bash
- language: node_js
services:
- docker
branches:
  only:
  - master
stages:
- build
- release
before_script:
- docker login -u "${DH_USERNAME}" -p "${DH_PASSWORD}";
after_script:
- docker logout
jobs:
  include:
  - stage: build
    if: branch = master
    env:
    - IMAGE_NAME: go
    script:
    - ./build.sh "${DH_REPO}" "${IMAGE_NAME}" "./go";
    - COMMIT_MESSAGE="${TRAVIS_COMMIT_MESSAGE}" ./publish.sh "${DH_REPO}" "${IMAGE_NAME}";
  - stage: release
    if: branch = master
    env:
    - TO: github
    script:
    - set -e;
    - |
      git checkout ${TRAVIS_BRANCH};
      LEVEL=patch;
      REGEX="\[(major|minor) release\]"; # use a variable otherwise it doesn't work ¯\_(ツ)_/¯
      if [[ "${TRAVIS_COMMIT_MESSAGE}" =~ ${REGEX} ]]; then
        LEVEL=${BASH_REMATCH[1]}; # BASH_REMATCH is automatically created by BASH when capturing a group
      fi;
      npm version "${LEVEL}";
      git push https://${GH_USERNAME}:${GH_TOKEN}@github.com/gdsace/docker-go.git ${TRAVIS_BRANCH} --tags;